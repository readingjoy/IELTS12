<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é€šç”¨è¯æ±‡æµ‹è¯•ç”Ÿæˆå™¨</title>
<script src="https://code.responsivevoice.org/responsivevoice.js?key=Fi7HhPlg"></script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.6;background:#f4f4f9;color:#333;margin:0;padding:20px}
.container{max-width:800px;margin:auto;background:#fff;padding:20px 30px;border-radius:8px;box-shadow:0 0 15px rgba(0,0,0,.1)}
header{text-align:center;border-bottom:2px solid #e0e0e0;padding-bottom:10px;margin-bottom:20px}
h1{margin:0;color:#4a4a4a}
header p{margin:5px 0 0;color:#777}
section{margin-bottom:30px}
h2{color:#0056b3;border-bottom:1px solid #ddd;padding-bottom:5px}
.question{margin-bottom:20px}
.options label{display:block;margin-bottom:8px;cursor:pointer;padding:5px;border-radius:4px}
.spelling-input{width:100%;max-width:250px;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:1em}
.show-hint-btn{margin-left:8px;font-size:.9em;padding:2px 6px}
#submit-btn,#start-test-btn{display:block;width:100%;padding:15px;font-size:1.2em;font-weight:bold;color:#fff;background:#007bff;border:none;border-radius:5px;cursor:pointer;transition:background .3s;margin-top:20px}
#submit-btn:hover,#start-test-btn:hover{background:#0056b3}
#submit-btn:disabled{background:#6c757d;cursor:not-allowed}
#results{display:none;text-align:center;margin-top:30px;padding:20px;border-radius:8px;background:#e9f7ef;color:#155724;border:1px solid #c3e6cb}
.score-breakdown{margin-top:20px;text-align:left}
.score-item{display:flex;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;border-bottom:1px dashed #ddd}
.correct-answer{background:#d4edda;color:#155724;border-left:5px solid #28a745}
.incorrect-answer{background:#f8d7da;color:#721c24;border-left:5px solid #dc3545}
.correct-input{border-color:#28a745;background:#d4edda}
.incorrect-input{border-color:#dc3545;background:#f8d7da}
.correct-spelling{color:#28a745;font-weight:bold;margin-left:10px}
.hidden{display:none}
.instructions{background:#e8f4fd;border-left:4px solid #17a2b8;padding:15px;margin:20px 0;border-radius:4px}


/* ========= è¯æ±‡å­¦ä¹ é¡µç¾åŒ– ========= */
#vocab-list {
    display: flex;
    flex-direction: column;
    gap: 12px;                      /* å¡ç‰‡é—´è· */
}
.vocab-item {
    display: flex;
    align-items: flex-start;
    padding: 14px 18px;
    border-radius: 8px;
    background: #ffffff;
    border: 1px solid #e5e7eb;      /* æŸ”å’Œè¾¹æ¡† */
    box-shadow: 0 2px 4px rgba(0,0,0,.04);
    transition: transform .2s, box-shadow .2s;
}
.vocab-item:nth-child(odd) {
    background: #f9fafb;            /* éš”è¡Œå˜è‰² */
}
.vocab-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,.06);
}
.vocab-word {
    width: 200px;
    font-weight: 700;
    font-size: 1.15em;
    color: #0056b3;                 /* ä¸»é¢˜è“ */
    flex-shrink: 0;
    margin-right: 20px;
}
.vocab-definition {
    flex: 1;
    color: #444;
    line-height: 1.55;
}

/* ========= æ–°å¢ï¼šå•è¯å‘éŸ³æŒ‰é’®æ ·å¼ ========= */
.word-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 10px; /* å•è¯å’ŒæŒ‰é’®ä¹‹é—´çš„é—´è· */
}
.pronounce-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 8px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
.pronounce-btn:hover {
    background: #218838;
    transform: scale(1.1);
}
.pronounce-btn:active {
    transform: scale(0.95);
}

/* è°ƒæ•´è¯æ±‡å•è¯çš„æ ·å¼ï¼Œä½¿å…¶ä¸æŒ‰é’®æ›´å¥½å¯¹é½ */
.vocab-word {
    width: auto; /* æ”¹ä¸ºè‡ªåŠ¨å®½åº¦ */
    font-weight: 700;
    font-size: 1.15em;
    color: #0056b3;
    flex-shrink: 0;
    margin-right: 0; /* ç§»é™¤å³è¾¹è· */
}

/* ========= æ–°å¢ï¼šå­¦ç”Ÿä¿¡æ¯è¾“å…¥æ ·å¼ ========= */
#student-info-inputs {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #fcfcfc;
}
#student-info-inputs label {
    font-weight: bold;
    color: #333;
}
#student-info-inputs input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    flex: 1;
    min-width: 100px;
}
/* ========= ç»“æœé¡µä¿¡æ¯æ ·å¼ ========= */
.student-info-result {
    padding: 10px 0;
    margin-bottom: 20px;
    border-bottom: 1px dashed #007bff;
    font-size: 1.1em;
}

/* ================================================= */
/* ========= å“åº”å¼ä¼˜åŒ–ï¼šé€‚ç”¨äºæ‰‹æœºç­‰å°å±å¹• (Max-width: 600px) ========= */
/* ================================================= */
@media (max-width: 600px) {
    body {
        padding: 10px; /* å‡å° body è¾¹è· */
    }

    .container {
        padding: 15px; /* å‡å° container å†…éƒ¨è¾¹è· */
        box-shadow: none; /* åœ¨æ‰‹æœºä¸Šç§»é™¤é˜´å½±ï¼Œæ˜¾å¾—æ›´åŸç”Ÿ */
    }

    /* ä¼˜åŒ–å¤´éƒ¨æ ‡é¢˜å¤§å° */
    h1 {
        font-size: 1.5em;
    }
    h2 {
        font-size: 1.2em;
    }

    /* å †å  'å§“å' å’Œ 'ç­çº§' è¾“å…¥æ¡† */
    #student-info-inputs {
        flex-direction: column;
        gap: 15px;
    }
    #student-info-inputs > div {
        width: 100%;
    }

    /* å †å è¯æ±‡å­¦ä¹ å¡ç‰‡ */
    .vocab-item {
        flex-direction: column;
        align-items: flex-start;
        padding: 10px 15px;
        gap: 5px; /* å•è¯ä¸å®šä¹‰ä¹‹é—´çš„é—´è· */
    }

    .vocab-word {
        width: 100%; /* å•è¯å æ®æ•´è¡Œ */
        margin-right: 0;
        font-size: 1.1em;
        margin-bottom: 5px;
    }
    
    .vocab-definition {
        font-size: 0.95em;
    }
    
    /* ä¼˜åŒ–æŒ‰é’®å¤§å° */
    #submit-btn, #start-test-btn, #back-to-vocab-btn {
        padding: 12px;
        font-size: 1.1em;
    }
    
    /* ä¼˜åŒ–æ‹¼å†™è¾“å…¥æ¡†å’Œæç¤ºæŒ‰é’® */
    .spelling-input {
        max-width: 100%; /* è¾“å…¥æ¡†å®½åº¦é“ºæ»¡ */
        margin-bottom: 10px; /* å¢åŠ åº•éƒ¨é—´è· */
    }

    .show-hint-btn {
        display: block; /* æç¤ºæŒ‰é’®ç‹¬å ä¸€è¡Œ */
        margin-left: 0;
        margin-top: 5px;
        width: 100%;
        padding: 8px 6px;
    }
    
    /* ä¼˜åŒ–ç»“æœé¡µåˆ†æ•°è¯¦æƒ… */
    .score-breakdown {
        font-size: 0.95em;
    }

    /* æ‰‹æœºç«¯ä¼˜åŒ–å‘éŸ³æŒ‰é’® */
    .pronounce-btn {
        padding: 6px;
        font-size: 0.85em;
        width: 28px;
        height: 28px;
    }
    
    .word-header {
        gap: 8px; /* æ‰‹æœºç«¯å‡å°é—´è· */
    }
}


</style>
</head>
<body>
<div class="container">
  <div id="vocab-page" class="page">
    <header>
      <h1 id="vocab-title"></h1>
      <p id="vocab-subtitle"></p>
    </header>
    <div class="instructions">
      <p><strong>å­¦ä¹ è¯´æ˜ï¼š</strong>è¯·å…ˆå­¦ä¹ ä»¥ä¸‹è¯æ±‡åŠå…¶è‹±æ–‡è§£é‡Šï¼Œç„¶åç‚¹å‡»"å¼€å§‹æµ‹è¯•"ã€‚</p>
<p><strong>Instructions:</strong> Please study the following vocabulary words and their English definitions before starting the test.</p>
    </div>
    <section>
      <h2>ç›®æ ‡è¯æ±‡ (Target Vocabulary)</h2>
      <div id="vocab-list" class="vocab-list"></div>
    </section>
    <button id="start-test-btn">å¼€å§‹æµ‹è¯• (Start Test)</button>
  </div>

  <div id="test-page" class="page hidden">
    <header>
      <h1 id="test-title"></h1>
      <p id="test-subtitle"></p>
    </header>
    <form id="quizForm">
      
      <div id="student-info-inputs">
          <div>
              <label for="studentName">å§“å (Name):</label>
              <input type="text" id="studentName" required placeholder="è¯·è¾“å…¥å§“å">
          </div>
          <div>
              <label for="studentClass">ç­çº§ (Class):</label>
              <input type="text" id="studentClass" required placeholder="è¯·è¾“å…¥ç­çº§/ç¼–å·">
          </div>
      </div>
      <section id="multiple-choice-section">
        <h2>ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯æ±‡é€‰æ‹©é¢˜ï¼ˆå…±<span id="mcq-count-mc">0</span>é¢˜ï¼Œæ¯é¢˜1åˆ†ï¼‰</h2>
      </section>
      <section id="spelling-section">
        <h2>ç¬¬äºŒéƒ¨åˆ†ï¼šè¯æ±‡æ‹¼å†™ï¼ˆå…±<span id="spelling-count-sp">0</span>é¢˜ï¼Œæ¯é¢˜1åˆ†ï¼‰</h2>
      </section>
    </form>
    
    <button id="back-to-vocab-btn" style="display:block; width:100%; padding:10px; font-size:1.1em; font-weight:bold; color:#007bff; background:#e0f0ff; border:1px solid #007bff; border-radius:5px; cursor:pointer; transition:background .3s; margin-top:10px;">
        â† è¿”å›è¯æ±‡å­¦ä¹  (Go back to Vocabulary List)
    </button>
    <button id="submit-btn">å®Œæˆæµ‹è¯•å¹¶è¯„åˆ† (Grade My Test)</button>
    <div id="results"></div>
  </div>
</div>

<script>
// ================================
// é…ç½®ä¸é¢˜åº“ - ç‹¬ç«‹æ–‡ä»¶ï¼Œæ–¹ä¾¿æ›¿æ¢
// ================================
const testConfig = {
    vocabTitle: "IELTS 12 T5 R1 è¯æ±‡å­¦ä¹  & æµ‹è¯•",
    vocabSubtitle: "Cork è¯æ±‡å­¦ä¹  & æµ‹è¯•",
    testTitle: "é«˜çº§è¯æ±‡ç»¼åˆæµ‹è¯•",
    testSubtitle: "Advanced Vocabulary Comprehensive Test"
};


const vocabularyList = [
    {word: "remarkable material", definition: "an extraordinary substance with unique properties", pronunciation: "remarkable material"},
    {word: "elastic", definition: "able to resume normal shape after being stretched or compressed", pronunciation: "elastic"},
    {word: "fire-resistant", definition: "not easily set on fire or damaged by fire", pronunciation: "fire resistant"},
    {word: "buoyant", definition: "able to float in liquid or air", pronunciation: "buoyant"},
    {word: "insulate", definition: "protect something by preventing heat, electricity, or sound from passing through", pronunciation: "insulate"},
    {word: "replicate", definition: "make an exact copy of; reproduce", pronunciation: "replicate"},
    {word: "succeed in", definition: "achieve the desired aim or result", pronunciation: "succeed in"},
    {word: "spring back", definition: "return quickly to original shape or position after being bent, stretched, or pressed", pronunciation: "spring back"},
    {word: "thrive", definition: "grow or develop well or vigorously", pronunciation: "thrive"},
    {word: "moisture", definition: "water or other liquid diffused in a small quantity as vapor", pronunciation: "moisture"},
    {word: "nutrient", definition: "a substance that provides nourishment essential for growth", pronunciation: "nutrient"},
    {word: "account for", definition: "constitute or make up a specified amount or proportion", pronunciation: "account for"},
    {word: "in patience", definition: "with calmness and self-control", pronunciation: "in patience"},
    {word: "strip cork bark", definition: "remove the outer layer from cork trees", pronunciation: "strip cork bark"},
    {word: "lever away", definition: "use a lever to remove or separate something", pronunciation: "lever away"},
    {word: "thermal insulation", definition: "the reduction of heat transfer between objects", pronunciation: "thermal insulation"},
    {word: "ideal for", definition: "perfectly suitable for a particular purpose", pronunciation: "ideal for"},
    {word: "concrete", definition: "a building material made from a mixture of cement, sand, and water", pronunciation: "concrete"},
    {word: "virtual monopoly", definition: "almost complete control of a product or service in a particular market", pronunciation: "virtual monopoly"},
    {word: "substitute", definition: "a person or thing acting or serving in place of another", pronunciation: "substitute"},
    {word: "in the case of", definition: "regarding the situation of", pronunciation: "in the case of"},
    {word: "screw caps", definition: "caps that are twisted onto containers to seal them", pronunciation: "screw caps"},
    {word: "desertification", definition: "the process by which fertile land becomes desert", pronunciation: "desertification"},
    {word: "promising", definition: "showing signs of future success or achievement", pronunciation: "promising"}
];

const multipleChoiceQuestions = [
    {
        question: "Graphene is a _______ with extraordinary strength and conductivity.",
        answers: ["remarkable material", "thermal insulation", "virtual monopoly", "promising substitute"],
        correct: "remarkable material"
    },
    {
        question: "Rubber bands are highly _______, returning to their original shape after stretching.",
        answers: ["elastic", "buoyant", "fire-resistant", "promising"],
        correct: "elastic"
    },
    {
        question: "Buildings in wildfire-prone areas require _______ materials for safety.",
        answers: ["fire-resistant", "elastic", "buoyant", "remarkable"],
        correct: "fire-resistant"
    },
    {
        question: "Cork is naturally _______, making it perfect for life jackets and floats.",
        answers: ["buoyant", "elastic", "fire-resistant", "ideal"],
        correct: "buoyant"
    },
    {
        question: "Proper home construction should _______ against both heat and cold.",
        answers: ["insulate", "replicate", "thrive", "account for"],
        correct: "insulate"
    },
    {
        question: "Scientists have attempted to _______ the unique properties of spider silk.",
        answers: ["replicate", "succeed in", "spring back", "stripe"],
        correct: "replicate"
    },
    {
        question: "After years of research, they finally _______ creating a sustainable alternative to plastic.",
        answers: ["succeeded in", "accounted for", "levered away", "stripped"],
        correct: "succeeded in"
    },
    {
        question: "High-quality memory foam will _______ after pressure is removed.",
        answers: ["spring back", "thrive", "insulate", "replicate"],
        correct: "spring back"
    },
    {
        question: "Certain plants _______ in arid conditions with minimal water.",
        answers: ["thrive", "insulate", "replicate", "substitute"],
        correct: "thrive"
    },
    {
        question: "Excess _______ can lead to mold growth in poorly ventilated buildings.",
        answers: ["moisture", "nutrient", "concrete", "desertification"],
        correct: "moisture"
    },
    {
        question: "Soil rich in _______ supports healthy plant growth.",
        answers: ["nutrients", "moisture", "insulation", "substitutes"],
        correct: "nutrients"
    },
    {
        question: "Renewable energy sources now _______ a significant portion of electricity generation.",
        answers: ["account for", "succeed in", "spring back", "thrive in"],
        correct: "account for"
    },
    {
        question: "Cork harvesters work _______ to ensure they don't damage the trees.",
        answers: ["in patience", "with promising results", "as a substitute", "in the case"],
        correct: "in patience"
    },
    {
        question: "Sustainable harvesting practices involve carefully _______ without harming the tree.",
        answers: ["stripping cork bark", "lever away", "screw caps", "thermal insulation"],
        correct: "stripping cork bark"
    },
    {
        question: "Workers use special tools to _______ the cork from the tree trunk.",
        answers: ["lever away", "stripe", "insulate", "replicate"],
        correct: "lever away"
    }
];

const spellingQuestions = [
    {
        sentence: "Proper _______ can reduce heating costs by up to 30%. (éš”çƒ­)",
        answer: "thermal insulation",
        hint: "t_______ i__________"
    },
    {
        sentence: "Cork is _______ packaging fragile items due to its cushioning properties. (ç†æƒ³çš„)",
        answer: "ideal for",
        hint: "i_____ f__"
    },
    {
        sentence: "Modern construction often uses _______ as a foundational material. (æ··å‡åœŸ)",
        answer: "concrete",
        hint: "c_______"
    },
    {
        sentence: "The company held a _______ on cork production for decades. (å®é™…å„æ–­)",
        answer: "virtual monopoly",
        hint: "v_______ m_______"
    },
    {
        sentence: "Researchers are seeking a sustainable _______ for single-use plastics. (æ›¿ä»£å“)",
        answer: "substitute",
        hint: "s_________"
    }
];
</script>
<script>
/* ================================ åº”ç”¨é€»è¾‘ ================================ */

// 1. å¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
window.onload = function() {
    window.scrollTo(0, 0); 
    document.body.scrollTop = 0; 
    document.documentElement.scrollTop = 0; 

    setTimeout(() => {
        window.scrollTo(0, 0);
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }, 100); 
};

/* Fisher-Yates æ‰“ä¹±  */
const shuffle = arr => { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } };

// çŠ¶æ€å’Œè®¡æ—¶å˜é‡
const correctAnswers = {};
let startTime, isTestGraded = false;

// 2. æ£€æŸ¥ SessionStorageï¼Œæ¢å¤é¡µé¢çŠ¶æ€
const vocabPage = document.getElementById('vocab-page');
const testPage = document.getElementById('test-page');

// =========================================================================
// ã€æ–°å¢ã€‘ä½œç­”çŠ¶æ€å­˜å‚¨ä¸æ¢å¤å‡½æ•° (åŒ…å«å§“åå’Œç­çº§)
// =========================================================================

function saveAnswers() {
    const form = document.getElementById('quizForm');
    const answers = {};
    
    // å­˜å‚¨å­¦ç”Ÿä¿¡æ¯
    const studentName = document.getElementById('studentName');
    const studentClass = document.getElementById('studentClass');
    if (studentName) answers['studentName'] = studentName.value.trim();
    if (studentClass) answers['studentClass'] = studentClass.value.trim();

    // å­˜å‚¨é€‰æ‹©é¢˜ç­”æ¡ˆ
    multipleChoiceQuestions.forEach((_, idx) => {
        const name = `q${idx+1}`;
        const checked = form.querySelector(`input[name="${name}"]:checked`);
        if (checked) {
            answers[name] = checked.value;
        }
    });

    // å­˜å‚¨æ‹¼å†™é¢˜ç­”æ¡ˆ
    spellingQuestions.forEach((_, idx) => {
        const id = `s${idx+1}`;
        const input = document.getElementById(id);
        if (input && input.value.trim() !== '') {
            answers[id] = input.value.trim();
        }
    });

    sessionStorage.setItem('testAnswers', JSON.stringify(answers));
}

function restoreAnswers() {
    const savedAnswers = sessionStorage.getItem('testAnswers');
    if (!savedAnswers) return;

    const answers = JSON.parse(savedAnswers);
    
    // æ¢å¤å­¦ç”Ÿä¿¡æ¯
    const studentName = document.getElementById('studentName');
    const studentClass = document.getElementById('studentClass');
    if (studentName && answers['studentName']) studentName.value = answers['studentName'];
    if (studentClass && answers['studentClass']) studentClass.value = answers['studentClass'];
    
    // æ¢å¤é€‰æ‹©é¢˜ç­”æ¡ˆ
    Object.keys(answers).forEach(name => {
        if (name.startsWith('q')) {
            const input = document.querySelector(`input[name="${name}"][value="${answers[name]}"]`);
            if (input) {
                input.checked = true;
            }
        }
        // æ¢å¤æ‹¼å†™é¢˜ç­”æ¡ˆ
        else if (name.startsWith('s')) {
            const input = document.getElementById(name);
            if (input) {
                input.value = answers[name];
            }
        }
    });
}
// =========================================================================

if (sessionStorage.getItem('testStarted') === 'true') {
    vocabPage.classList.add('hidden');
    testPage.classList.remove('hidden');
    // å¦‚æœæ˜¯åˆ·æ–°å›åˆ°æµ‹è¯•é¡µï¼Œé‡ç½®è®¡æ—¶å™¨
    startTime = new Date(); 
    restoreAnswers(); // åˆ‡æ¢æ—¶ç«‹å³æ¢å¤ç­”æ¡ˆ
} else {
    // é»˜è®¤æ˜¾ç¤ºå­¦ä¹ é¡µ
    vocabPage.classList.remove('hidden');
    testPage.classList.add('hidden');
}


/* é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰“ä¹±  */
if (typeof vocabularyList !== 'undefined') {
    shuffle(vocabularyList);
}
shuffle(multipleChoiceQuestions);
shuffle(spellingQuestions);


/* -------- è¯æ±‡åˆ—è¡¨æ¸²æŸ“ -------- */
const vocabList = document.getElementById('vocab-list');
// å‡è®¾ vocabularyList åœ¨ vocab-data.js ä¸­å®šä¹‰
if (typeof vocabularyList !== 'undefined') {
    vocabularyList.forEach(v => {
      const item = document.createElement('div');
      item.className = 'vocab-item';
      item.innerHTML = `
        <div class="word-header">
          <div class="vocab-word">${v.word}</div>
          <button class="pronounce-btn" onclick="responsiveVoice.speak('${v.pronunciation}')" title="å‘éŸ³">
            ğŸ”Š
          </button>
        </div>
        <div class="vocab-definition">${v.definition}</div>`;
      vocabList.appendChild(item);
    });
}


/* -------- é€‰æ‹©é¢˜ç”Ÿæˆ -------- */
const mcSection = document.getElementById('multiple-choice-section');
multipleChoiceQuestions.forEach((q, idx) => {
  const div = document.createElement('div');
  div.className = 'question';
  const qName = `q${idx+1}`;
  div.innerHTML = `
    <p>${idx+1}. ${q.question}</p>
    <div class="options">
      ${q.answers.map((ans, i) => `
        <label for="${qName}_${i}">
          <input type="radio" id="${qName}_${i}" name="${qName}" value="${['A','B','C','D'][i]}">
          ${['A','B','C','D'][i]}. ${ans}
        </label>`).join('')}
    </div>`;
  mcSection.appendChild(div);
  const correctIndex = q.answers.indexOf(q.correct);
  correctAnswers[qName] = ['A','B','C','D'][correctIndex];
});

/* -------- æ‹¼å†™é¢˜ç”Ÿæˆ -------- */
const spSection = document.getElementById('spelling-section');
spellingQuestions.forEach((q, idx) => {
  const div = document.createElement('div');
  div.className = 'question';
  const sId = `s${idx+1}`;
  div.innerHTML = `
    <label for="${sId}">${idx+1}. ${q.sentence.replace('_______', '<span class="spelling-hint">_______</span>')}</label>
    <input type="text" id="${sId}" class="spelling-input">
    <button type="button" class="show-hint-btn" data-for="${sId}">æ˜¾ç¤ºæç¤º</button>
    <span class="correct-spelling" style="display:none;">æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}</span>`;
  spSection.appendChild(div);
  correctAnswers[sId] = q.answer;
});

// =========================================================================
// ã€æ–°å¢ã€‘ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶ä¿å­˜ä½œç­”çŠ¶æ€ (åŒ…æ‹¬å§“åå’Œç­çº§)
// =========================================================================
document.getElementById('quizForm').addEventListener('input', saveAnswers);
document.getElementById('student-info-inputs').addEventListener('input', saveAnswers);
// =========================================================================


/* 1. æ˜¾ç¤ºæç¤ºæŒ‰é’® */
document.querySelectorAll('.show-hint-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const input = document.getElementById(this.dataset.for);
    const questionData = spellingQuestions.find((_, i) => `s${i+1}` === this.dataset.for);
    if (questionData) {
        input.placeholder = questionData.hint;
        this.disabled = true;
        this.textContent = 'å·²æ˜¾ç¤º';
    }
  });
});

/* é¡µé¢åˆ‡æ¢ï¼šå¼€å§‹æµ‹è¯• */
document.getElementById('start-test-btn').addEventListener('click', () => {
  // è®¾ç½® SessionStorage æ ‡å¿—
  sessionStorage.setItem('testStarted', 'true');
    
  window.scrollTo({ top: 0, behavior: 'instant' });   
  vocabPage.classList.add('hidden');
  testPage.classList.remove('hidden');
  startTime = new Date();
  restoreAnswers(); // ç¡®ä¿ä»å­¦ä¹ é¡µè¿›å…¥æµ‹è¯•é¡µæ—¶æ¢å¤æ‰€æœ‰æ•°æ®
});

/* é¡µé¢åˆ‡æ¢ï¼šè¿”å›å­¦ä¹ é¡µ */
document.getElementById('back-to-vocab-btn').addEventListener('click', () => {
    // ç§»é™¤çŠ¶æ€æ ‡å¿—ï¼Œç¡®ä¿ä¸‹æ¬¡å›åˆ°æµ‹è¯•é¡µæ—¶ï¼Œè®¡æ—¶é‡æ–°å¼€å§‹
    sessionStorage.removeItem('testStarted'); 
    sessionStorage.removeItem('testAnswers'); // æ¸…é™¤ç­”æ¡ˆï¼Œé‡ç½®çŠ¶æ€
    
    // åˆ‡æ¢é¡µé¢
    window.scrollTo({ top: 0, behavior: 'instant' });
    testPage.classList.add('hidden');
    vocabPage.classList.remove('hidden');

    // æ¸…ç©ºç»“æœåŒºåŸŸï¼Œé¿å…ä¸‹æ¬¡è¿›å…¥å­¦ä¹ é¡µæ—¶åº•éƒ¨ä»æ˜¾ç¤ºæ—§ç»“æœ
    document.getElementById('results').style.display = 'none';
    document.getElementById('submit-btn').textContent = 'å®Œæˆæµ‹è¯•å¹¶è¯„åˆ† (Grade My Test)';
});

/* ç¦»å¼€é¡µé¢æ—¶æ¸…é™¤çŠ¶æ€ */
window.addEventListener('beforeunload', () => {
    if (isTestGraded) {
        sessionStorage.removeItem('testStarted');
        sessionStorage.removeItem('testAnswers'); // æœ€ç»ˆå®Œæˆæ—¶æ¸…é™¤ç­”æ¡ˆ
    }
});


/* è¯„åˆ† (å·²ä¿®æ”¹é€»è¾‘ï¼ŒåŒ…å«å§“åå’Œç­çº§å±•ç¤º) */
document.getElementById('submit-btn').addEventListener('click', () => {
    if (isTestGraded) return alert('æµ‹è¯•å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹æœ€ç»ˆç»“æœã€‚');

    // -------------------------------------------------------------------------
    // ã€ä¿®æ”¹ç‚¹ 2Aã€‘è·å–å§“åå’Œç­çº§ï¼Œå¹¶è¿›è¡Œå¼ºåˆ¶æ£€æŸ¥
    // -------------------------------------------------------------------------
    const studentNameInput = document.getElementById('studentName');
    const studentClassInput = document.getElementById('studentClass');
    const studentName = studentNameInput ? studentNameInput.value.trim() : 'N/A';
    const studentClass = studentClassInput ? studentClassInput.value.trim() : 'N/A';
    
    // å¼ºåˆ¶è¾“å…¥æ£€æŸ¥
    if (studentName === '' || studentClass === '') {
        alert('è¯·å…ˆè¾“å…¥ä½ çš„å§“åå’Œç­çº§æ‰èƒ½è¯„åˆ†ï¼');
        if (studentName === '') studentNameInput.focus();
        else if (studentClass === '') studentClassInput.focus();
        return;
    }
    // -------------------------------------------------------------------------

    const end = new Date();
    const seconds = Math.round((end - startTime) / 1000);
    const min = Math.floor(seconds / 60), sec = seconds % 60;

    const form = document.getElementById('quizForm');
    let mcScore = 0;
    let spScore = 0;
    let unansweredCount = 0;

    /* åˆ¤é€‰æ‹©é¢˜ */
    multipleChoiceQuestions.forEach((_, idx) => {
        const name = `q${idx+1}`;
        const questionDiv = form.elements[name][0].closest('.question'); 
        const inputElements = form.elements[name];

        if (questionDiv) {
            Array.from(questionDiv.querySelectorAll('.options label')).forEach(l => l.classList.remove('correct-answer', 'incorrect-answer'));
        }
        
        const checked = form.querySelector(`input[name="${name}"]:checked`);
        
        if (!checked) {
            unansweredCount++;
            return; 
        }

        Array.from(inputElements).forEach(input => input.disabled = true); 

        const label = checked.parentElement;
        if (checked.value === correctAnswers[name]) {
            mcScore++; 
            label.classList.add('correct-answer');
        } else {
            label.classList.add('incorrect-answer');
            document.querySelector(`input[name="${name}"][value="${correctAnswers[name]}"]`).parentElement.classList.add('correct-answer');
        }
    });

    /* åˆ¤æ‹¼å†™é¢˜ */
    document.querySelectorAll('.correct-spelling').forEach(s => s.style.display = 'none'); 
    spellingQuestions.forEach((_, idx) => {
        const id = `s${idx+1}`;
        const input = document.getElementById(id);
        const user = input.value.trim();
        
        input.classList.remove('correct-input', 'incorrect-input');
        
        if (!user) {
            unansweredCount++;
            return; 
        }
        
        input.disabled = true; 
        const hintBtn = document.querySelector(`button[data-for="${id}"]`);
        if (hintBtn) hintBtn.disabled = true; 

        const correctAnswerVariants = correctAnswers[id].toLowerCase().split('/').map(ans => ans.trim());
        
        if (correctAnswerVariants.includes(user.toLowerCase())) {
            spScore++; 
            input.classList.add('correct-input');
        } else {
            input.classList.add('incorrect-input');
            document.getElementById(id).nextElementSibling.nextElementSibling.style.display = 'inline'; 
        }
    });

    const totalQuestions = multipleChoiceQuestions.length + spellingQuestions.length;
    const answeredCount = totalQuestions - unansweredCount;
    const currentScore = mcScore + spScore;
    const res = document.getElementById('results');
    
    // -------------------------------------------------------------------------
    // ã€ä¿®æ”¹ç‚¹ 2Bã€‘åˆ›å»ºè¦æ’å…¥çš„ HTML ç»“æœ (åŒ…å«å­¦ç”Ÿä¿¡æ¯)
    // -------------------------------------------------------------------------
    const studentInfoHTML = `
        <div class="student-info-result">
            <p style="margin: 5px 0;"><strong>å­¦ç”Ÿå§“å (Name):</strong> ${studentName}</p>
            <p style="margin: 5px 0;"><strong>å­¦ç”Ÿç­çº§ (Class):</strong> ${studentClass}</p>
        </div>
    `;

    // --- ç»“æœå’ŒæŒ‰é’®çŠ¶æ€æ›´æ–° ---
    if (unansweredCount === 0) {
        // æ‰€æœ‰é¢˜ç›®å‡å·²å®Œæˆ
        res.innerHTML = `
            ${studentInfoHTML}
            <h2>æ­å–œï¼ä½ çš„æœ€ç»ˆæ€»åˆ†ï¼š${currentScore} / ${totalQuestions}</h2>
            <div class="score-breakdown">
                <div class="score-item"><span>é€‰æ‹©é¢˜</span><span>${mcScore} / ${multipleChoiceQuestions.length}</span></div>
                <div class="score-item"><span>è¯æ±‡æ‹¼å†™</span><span>${spScore} / ${spellingQuestions.length}</span></div>
            </div>
            <div class="time-taken">å®Œæˆç”¨æ—¶ï¼š${min} åˆ† ${sec} ç§’</div>
            <p style="color:#28a745; font-weight:bold;">æ‰€æœ‰é¢˜ç›®å·²é”å®šï¼Œè¯·æŸ¥çœ‹ä½ çš„æœ€ç»ˆè¡¨ç°ã€‚</p>
        `;
        isTestGraded = true;
        sessionStorage.removeItem('testStarted'); // æœ€ç»ˆå®Œæˆï¼Œæ¸…é™¤çŠ¶æ€
        sessionStorage.removeItem('testAnswers'); // æœ€ç»ˆå®Œæˆï¼Œæ¸…é™¤ç­”æ¡ˆ
        document.getElementById('submit-btn').textContent = 'æµ‹è¯•å·²å®Œæˆ (Test Completed)';
        document.getElementById('submit-btn').disabled = true;
    } else {
        // ä»æœ‰é¢˜ç›®æœªå®Œæˆ
        res.innerHTML = `
            ${studentInfoHTML}
            <h2>å½“å‰å¾—åˆ†ï¼š${currentScore} / ${answeredCount} (å·²ä½œç­”é¢˜ç›®)</h2>
            <p style="color:#ffc107; font-weight:bold;">âš ï¸ è¿˜æœ‰ ${unansweredCount} é¢˜æœªä½œç­”ï¼å·²ä½œç­”é¢˜ç›®å·²è¢«é”å®šï¼Œè¯·ç»§ç»­å®Œæˆå‰©ä½™é¢˜ç›®åï¼Œå†æ¬¡ç‚¹å‡»æŒ‰é’®è¯„åˆ†ã€‚</p>
            <div class="score-breakdown">
                <div class="score-item"><span>é€‰æ‹©é¢˜</span><span>${mcScore} / ${multipleChoiceQuestions.length}</span></div>
                <div class="score-item"><span>è¯æ±‡æ‹¼å†™</span><span>${spScore} / ${spellingQuestions.length}</span></div>
            </div>
            <div class="time-taken" style="margin-top: 10px;">æœ¬æ¬¡ç”¨æ—¶è®¡ç®—è‡³æ­¤ï¼š${min} åˆ† ${sec} ç§’</div>
        `;
        document.getElementById('submit-btn').textContent = `ç»§ç»­è¯„åˆ†/æäº¤ (${unansweredCount} é¢˜æœªå®Œæˆ)`;
    }
    // -------------------------------------------------------------------------

    res.style.display = 'block';
    res.scrollIntoView({ behavior: 'smooth' });
});


/* è®¡æ•°ä¸æ ‡é¢˜ */
document.getElementById('mcq-count').textContent = multipleChoiceQuestions.length;
document.getElementById('spelling-count').textContent = spellingQuestions.length;
document.getElementById('mcq-count-mc').textContent = multipleChoiceQuestions.length; // æ›´æ–°æµ‹è¯•é¡µè®¡æ•°
document.getElementById('spelling-count-sp').textContent = spellingQuestions.length; // æ›´æ–°æµ‹è¯•é¡µè®¡æ•°
if (typeof testConfig !== 'undefined') {
    Object.keys(testConfig).forEach(k => {
      const el = document.getElementById(k.replace(/([A-Z])/g, '-$1').toLowerCase());
      if (el) el.textContent = testConfig[k];
    });
}
</script>
</body>
</html>